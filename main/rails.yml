- name: Pull Docker image for Rails app
  tags:
    - pull-rails
    - pull-all
  docker_image:
    name: erikperkins/rails_app

- name: Start Rails container
  tags:
    - start-rails
    - start-all
  docker_container:
    name: rails
    image: erikperkins/rails_app
    hostname: rails
    entrypoint: /rails_app/docker-entrypoint.sh
    command: bin/rails server --port 80 --binding 0.0.0.0
    restart_policy: on-failure
    env:
      RAILS_ENV: production
      RUBY_SECRET_KEY_BASE: "{{ lookup('env', 'RUBY_SECRET_KEY_BASE') }}"
      REDIS_URL: redis://storage.datapun.net:6379
      REDIS_HOST: storage.datapun.net
      POSTGRES_HOST: storage.datapun.net
      PHOENIX_HOST: timeseries.datapun.net
      FLASK_HOST: mnist.datapun.net
      FINCH_HOST: main.datapun.net:1025
    ports: 1024:80
    volumes: public:/rails_app/public/

- name: Start Rails resque-scheduler container
  tags:
    - start-rails
    - start-resque-scheduler
    - start-all
  docker_container:
    name: resque-scheduler
    image: erikperkins/rails_app
    env:
      RAILS_ENV: production
      RUBY_SECRET_KEY_BASE: "{{ lookup('env', 'RUBY_SECRET_KEY_BASE') }}"
      REDIS_URL: redis://storage.datapun.net:6379
      REDIS_HOST: storage.datapun.net
      POSTGRES_HOST: storage.datapun.net
      FLASK_HOST: mnist.datapun.net
      FINCH_HOST: main.datapun.net:1025
    command: bin/bundle exec rake environment resque:scheduler
    restart_policy: always

- name: Start Rails resque-worker container
  tags:
    - start-rails
    - start-resque-worker
    - start-all
  docker_container:
    name: resque-worker
    image: erikperkins/rails_app
    env:
      RAILS_ENV: production
      RUBY_SECRET_KEY_BASE: "{{ lookup('env', 'RUBY_SECRET_KEY_BASE') }}"
      REDIS_URL: redis://storage.datapun.net:6379
      REDIS_HOST: storage.datapun.net
      POSTGRES_HOST: storage.datapun.net
      FLASK_HOST: mnist.datapun.net
      FINCH_HOST: main.datapun.net:1025
      QUEUE: '*'
      LOGGING: 1
    command: bin/bundle exec rake environment resque:work
    restart_policy: always

- name: Stop Rails app
  tags:
    - stop-rails
    - stop-all
  docker_container:
    name: rails
    state: absent

- name: Stop Rails resque-scheduler container
  tags:
    - stop-rails
    - stop-resque-scheduler
    - stop-all
  docker_container:
    name: resque-scheduler
    state: absent

- name: Stop Rails resque-worker container
  tags:
    - stop-rails
    - stop-resque-worker
    - stop-all
  docker_container:
    name: resque-worker
    state: absent
